{% load crispy_forms_tags %}

<div class="modal-dialog modal-sm" role="document">
    <form action="{% url 'update' id=id sys=system%}" method="post" id="form" name="myform" class="form">{% csrf_token %}
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Ã—</span>
                    <span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body">
                {{system}}
                {{id}}
                {{ form|crispy }}
               {%if status == 'GREEN' %}
               <p>UpTime is {{downTime}}</p>
               {%elif status == 'RED'%}
                <p>DownTIme is {{downTime}}</p>
                {%endif%}
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <input type="submit" class="btn btn-primary" value="Save changes" />
            </div>
        </div><!-- /.modal-content -->
    </form>
</div><!-- /.modal-dialog -->
<script>
var loc = window.location
console.log(loc)
var form = $('#form')
var wsStart = 'ws://'
if (loc.protocol == 'https:'){
    wsStart = 'wss://'
}
var endpoint = wsStart + loc.host + loc.pathname
console.log('host = ' + loc.host)
console.log('pathname = ' + loc.pathname)
 var socket = new WebSocket(endpoint)

 socket.onopen = function(e){
        console.log('openEDDD',e)
        var from
             var elevatorID
              var elevatorStatus
              console.log('befor Send' + '')
        form.submit(function(event){
                    console.log('form saved')
                    var final_data
                    console.log(' system is {{system}}')
                    if( '{{system}}' === 'elev' ){
                       
                        elevatorID = '{{id}}'
                            elevatorStatus = document.myform.Elevator_Status_Choice.value
                            from = 'elev'
                              final_data = {
                                'elevatorID': elevatorID,
                                'elevatorStat':elevatorStatus,
                                'from':from,
                            }
                            }
                    else if( '{{system}}' === 'bridge'  || '{{system}}' === 'PCA'  || '{{system}}' === 'GPU' ){
                       
                        bridgeTableID = '{{id}}'
                            bridgeStatus = document.myform.Bridge_Status_Choice.value
                            pcaStatus = document.myform.PCA_Status_Choice.value
                             gpuStatus = document.myform.GPU_Status_Choice.value
                            from = 'bridge'
                             final_data = {
                                'bridgeTableID': bridgeTableID,
                                'bridgeStat':bridgeStatus,
                                'pcaStat': pcaStatus,
                                'gpuStat': gpuStatus,
                                'from': from,
                            }
                           }

                            socket.send(JSON.stringify(final_data));
                            console.log('sent data')
        });
                            
 }
</script>

<script>
    var form_options = { target: '#modal', success: function(response) {} };
    $('#form').ajaxForm(form_options);
</script>


